from collections import defaultdict
from random import choice

def markov_chain(words):
    grams = list(zip(words, words[1:], words[2:]))
    chain = defaultdict(list)
    for w1, w2, w3 in grams[:-1]:
        chain[(w1, w2)].append(w3)
    return chain

def generate_text(chain, length):
    text = [*choice([words for words in chain.keys() if words[0][0].isupper()])]
    for i in range(1, length):
        last = (text[i-1], text[i])
        text.append(choice(chain[last]))
    if any('.' in word for words in chain.keys() for word in words):
        text.append(choice([words[1] for words in chain.keys() if words[1][-1] == '.']))
    return ' '.join(text)

def main():
    text = []
    with open('poe.txt', 'r') as f:
        for line in f:
            for word in line.split():
                text.append(word)
    chain = markov_chain(text)
    print(generate_text(chain, 500))
    
main()
